<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Draw Entry</title>
  <meta name="description" content="Complete the steps to enter the lucky draw." />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-502386890"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-502386890');
  </script>

  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --text:#e6ebff; --muted:#9fb0d6;
      --btn:#7c9cff; --danger:#ef4444; --ok:#10b981;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:0 auto; padding:18px; }
    .top{ text-align:center; margin:20px 0; }
    .top img{ max-width:200px; height:auto; display:block; margin:0 auto 8px; }
    h1{ margin:8px 0 6px; }
    #countdown{ text-align:center; font-weight:700; margin:4px 0 0; }
    .muted{ color:var(--muted); }
    .step{ display:none; text-align:center; margin:18px auto; max-width:640px; background:var(--card); border:1px solid #1e293b; border-radius:12px; padding:18px; }
    .step.active{ display:block; }
    button, a.btn{
      padding:10px 18px; margin:8px; border-radius:8px; background:var(--btn);
      color:#000; font-weight:600; border:none; cursor:pointer; text-decoration:none; display:inline-block;
    }
    button[disabled], .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .row{ margin:10px 0; }
    input{
      padding:10px 12px; border-radius:8px; border:1px solid #334155;
      width:min(420px, 92%); background:#0e1530; color:#e2e8f0;
    }
    .err{ display:none; color:var(--danger); font-size:12px; margin-top:6px; }
    .ok{ color:var(--ok); font-size:12px; margin-top:6px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <img src="logo.png" alt="Realone Invest Logo"/>
      <h1>Lucky Draw Entry</h1>
      <div id="countdown">Loading countdownâ€¦</div>
      <p class="muted" id="announceLine">Winner will be announced on Sep 15, 2025 on our social channels.</p>
    </div>

    <!-- Step 0 -->
    <div class="step active" id="step0">
      <p>Complete the 3 steps to enter the lucky draw.</p>
      <button id="startBtn">Start</button>
    </div>

    <!-- Step 1: LinkedIn -->
    <div class="step" id="step1">
      <p><strong>Step 1:</strong> Follow us on LinkedIn</p>
      <a href="#" id="linkedin" class="btn" target="_blank" rel="noopener">Open LinkedIn</a><br/>
      <button id="continueLinkedIn" style="display:none;">Iâ€™ve Followed</button>
      <div class="ok" id="ok-li">âœ” LinkedIn step recorded</div>
    </div>

    <!-- Step 2: WhatsApp -->
    <div class="step" id="step2">
      <p><strong>Step 2:</strong> Join our WhatsApp group</p>
      <a href="#" id="whatsapp" class="btn" target="_blank" rel="noopener">Open WhatsApp</a><br/>
      <button id="continueWhatsApp" style="display:none;">Iâ€™ve Joined</button>
      <div class="ok" id="ok-wa">âœ” WhatsApp step recorded</div>
    </div>

    <!-- Step 3: Facebook -->
    <div class="step" id="step3">
      <p><strong>Step 3:</strong> Like/Join our Facebook page</p>
      <a href="#" id="facebook" class="btn" target="_blank" rel="noopener">Open Facebook</a><br/>
      <button id="continueFacebook" style="display:none;">Done</button>
      <div class="ok" id="ok-fb">âœ” Facebook step recorded</div>
    </div>

    <!-- Step 4: Form (with inline errors) -->
    <div class="step" id="step4">
      <p><strong>Final:</strong> Enter your details</p>
      <form id="entryForm" novalidate>
        <div class="row">
          <input type="text" id="name" placeholder="Full name" required>
        </div>

        <div class="row">
          <input type="tel" id="mobile" placeholder="Mobile number" required>
          <div id="err-mobile" class="err"></div>
        </div>

        <div class="row">
          <input type="email" id="email" placeholder="Email (optional)">
        </div>

        <div class="row">
          <input type="text" id="coupon" placeholder="Coupon ID (optional)">
          <div id="err-coupon" class="err"></div>
        </div>

        <div class="row">
          <label style="font-size:14px;">
            <input type="checkbox" id="consent" required> I agree to the Terms and allow you to contact me about the draw.
          </label>
        </div>

        <div class="row">
          <button type="submit" id="submitBtn" disabled>Enter Lucky Draw</button>
        </div>
      </form>
    </div>

    <!-- Step 5: Done -->
    <div class="step" id="step5">
      <p id="successMsg" style="font-size:18px; font-weight:600; color:#10b981;">
        ğŸ‰ You are now officially entered into the Lucky Draw!
      </p>
      <p class="muted">
        Stay tuned â€” winners will be announced on our social channels.<br>
        Happy Ganesh Chaturthi & Good luck ğŸ•‰ï¸ ğŸ˜
      </p>
      <button onclick="goTo(0)">Enter Another</button>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const LINKS = {
      linkedIn: "https://www.linkedin.com/company/realoneinvest/",
      whatsapp: "https://chat.whatsapp.com/JVGBPB50vxbIv8txxPld9B?mode=ems_qr_t",
      facebook: "https://www.facebook.com/RealoneInvest/"
    };
    const DRAW_DEADLINE = "2025-09-15T17:00:00-05:00";
    // Your Apps Script Web App URL (current)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzeGLTpCka8Nv7Auc14YIfAMJIHViCKH0Ng3cJFm64zebcuUG_vPjM9D81bEkSyGNR/exec";
    /* ================== */

    const $ = id => document.getElementById(id);

    // Steps nav
    function goTo(n){
      document.querySelectorAll(".step").forEach((s,i)=>s.classList.toggle("active", i===n));
      if (typeof gtag==='function') gtag('event','step_change',{step:n});
    }

    // Set links
    $("linkedin").href = LINKS.linkedIn;
    $("whatsapp").href = LINKS.whatsapp;
    $("facebook").href = LINKS.facebook;

    // Start step
    $("startBtn").addEventListener("click", ()=>goTo(1));

    // Gate each step: show Continue only after link click
    $("linkedin").addEventListener("click", ()=>{
      $("continueLinkedIn").style.display = "inline-block";
      $("ok-li").style.display = "block";
    });
    $("continueLinkedIn").addEventListener("click", ()=>goTo(2));

    $("whatsapp").addEventListener("click", ()=>{
      $("continueWhatsApp").style.display = "inline-block";
      $("ok-wa").style.display = "block";
    });
    $("continueWhatsApp").addEventListener("click", ()=>goTo(3));

    $("facebook").addEventListener("click", ()=>{
      $("continueFacebook").style.display = "inline-block";
      $("ok-fb").style.display = "block";
    });
    $("continueFacebook").addEventListener("click", ()=>goTo(4));

    // Countdown
    function tickCountdown(){
      const el=$("countdown");
      const diff = new Date(DRAW_DEADLINE).getTime()-Date.now();
      if(diff<=0){ el.textContent="Entries closed"; document.querySelectorAll("button, a.btn").forEach(b=>b.disabled=true); return; }
      const d=Math.floor(diff/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
      el.textContent=`${d}d ${h}h ${m}m ${s}s left to enter`;
    }
    tickCountdown(); setInterval(tickCountdown,1000);

    // ===== JSONP duplicate pre-checks =====
    let mobileOK = false;
    let couponOK = true; // coupon optional

    function showFieldError(el, msg){
      el.textContent = msg || '';
      el.style.display = msg ? 'block' : 'none';
    }

    function jsonp(url, cbName){
      return new Promise((resolve) => {
        const script = document.createElement('script');
        const cleanup = () => { script.remove(); try{ delete window[cbName]; }catch{} };
        window[cbName] = (data) => { cleanup(); resolve(data); };
        script.src = url;
        script.onerror = () => { cleanup(); resolve({status:'ERROR'}); };
        document.body.appendChild(script);
      });
    }

    async function checkMobile(){
      const mobile = $("mobile").value.trim();
      if (!mobile){ mobileOK=false; showFieldError($("err-mobile"), ''); updateSubmit(); return; }
      const cb = 'cb_m_'+Date.now();
      const url = `${APPS_SCRIPT_URL}?check=mobile&value=${encodeURIComponent(mobile)}&callback=${cb}`;
      const res = await jsonp(url, cb); // {status:'AVAILABLE'|'TAKEN'}
      if (res.status === 'TAKEN'){
        mobileOK=false;
        showFieldError($("err-mobile"), 'This mobile number is already registered.');
      } else if (res.status === 'AVAILABLE'){
        mobileOK=true;
        showFieldError($("err-mobile"), '');
      } else {
        // if checker failed, allow submit but backend will still block duplicates
        mobileOK=true;
        showFieldError($("err-mobile"), '');
      }
      updateSubmit();
    }

    async function checkCoupon(){
      const coupon = $("coupon").value.trim();
      if (!coupon){ couponOK=true; showFieldError($("err-coupon"), ''); updateSubmit(); return; }
      const cb = 'cb_c_'+Date.now();
      const url = `${APPS_SCRIPT_URL}?check=coupon&value=${encodeURIComponent(coupon)}&callback=${cb}`;
      const res = await jsonp(url, cb);
      if (res.status === 'TAKEN'){
        couponOK=false;
        showFieldError($("err-coupon"), 'This coupon ID is already registered.');
      } else if (res.status === 'AVAILABLE'){
        couponOK=true;
        showFieldError($("err-coupon"), '');
      } else {
        couponOK=true;
        showFieldError($("err-coupon"), '');
      }
      updateSubmit();
    }

    $("mobile").addEventListener('blur', checkMobile);
    $("coupon").addEventListener('blur', checkCoupon);

    function updateSubmit(){
      $("submitBtn").disabled = !(mobileOK && couponOK && $("name").value.trim() && $("consent").checked);
    }
    $("name").addEventListener('input', updateSubmit);
    $("consent").addEventListener('change', updateSubmit);

    // ===== Submit (POST via no-cors; server still enforces duplicates) =====
    $("entryForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!mobileOK || !couponOK){ return; }
      if (!$("consent").checked){ alert("Please agree to the Terms."); return; }

      const name   = $("name").value.trim();
      const mobile = $("mobile").value.trim();
      const email  = $("email").value.trim();
      const coupon = $("coupon").value.trim();

      const payload = {
        name, mobile, email, coupon,
        steps: { linkedin:true, whatsapp:true, facebook:true },
        ts: new Date().toISOString(),
        userAgent: navigator.userAgent,
        lang: navigator.language
      };

      try{
        // Use no-cors to avoid CORS error (we can't read the response; pre-checks handle UX)
        await fetch(APPS_SCRIPT_URL, {
          method:"POST",
          mode:"no-cors",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        // Success screen (canâ€™t read response, but server still blocks true duplicates)
        goTo(5);
        $("successMsg").innerHTML = `ğŸ•‰ï¸ğŸ˜ğŸ‰ Thank you, <b>${name}</b>! You are now officially entered into the Lucky Draw! ğŸ‰ğŸ˜ğŸ•‰ï¸`;
      }catch(err){
        console.error(err);
        alert("Submission failed. Please try again.");
      }
    });
  </script>
</body>
</html>
